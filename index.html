<script type="module">
    // ライブラリから'pipeline'と'env'をインポートする
    const { pipeline, env } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1');
    
    // インターネット上からのモデルダウンロードを許可する
    env.allowRemoteModels = true;

    // HTML要素を取得
    const imageInput = document.getElementById('image-input');
    const searchButton = document.getElementById('search-button');
    const resultsDiv = document.getElementById('results');
    const statusDiv = document.getElementById('status');
    
    // AIモデル（パイプライン）を準備
    statusDiv.textContent = 'AIモデルを準備中です... (初回は時間がかかります)';
    const extractor = await pipeline('feature-extraction', 'Xenova/clip-vit-base-patch32');
    statusDiv.textContent = '準備完了。画像をアップロードしてください。';

    // 検索ボタンがクリックされたときの処理
    searchButton.addEventListener('click', () => {
        if (!imageInput.files || imageInput.files.length === 0) {
            alert('画像を選択してください。');
            return;
        }

        const file = imageInput.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
            const imageUrl = e.target.result;
            const image = new Image();
            
            image.onload = async () => {
                statusDiv.textContent = '画像をベクトルに変換しています...';

                // ★★★ ここが修正点 ★★★
                // オプションを削除し、最もシンプルな形で呼び出す
                const embeddings = await extractor(image);

                statusDiv.textContent = '類似画像を検索しています...';

                // Cloudflare WorkersのAPIにリクエスト
                const response = await fetch('https://image-search-api.corsicajp.workers.dev', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query_vector: Array.from(embeddings.data) })
                });

                if (!response.ok) {
                    statusDiv.textContent = `エラーが発生しました: ${response.statusText}`;
                    return;
                }

                const similarImages = await response.json();

                // 結果を表示
                resultsDiv.innerHTML = '';
                if (similarImages && similarImages.length > 0) {
                    statusDiv.textContent = `${similarImages.length}件の類似画像が見つかりました。`;
                    similarImages.forEach(img => {
                        const p = document.createElement('p');
                        p.textContent = `ファイル名: ${img.image_path}, 類似度: ${img.similarity.toFixed(4)}`;
                        resultsDiv.appendChild(p);
                    });
                } else {
                    statusDiv.textContent = '類似する画像は見つかりませんでした。';
                }
            };

            image.src = imageUrl;
        };
        
        reader.readAsDataURL(file);
    });
</script>